name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Lua 5.1
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.1"

      - name: Run tests
        run: lua tests/run_tests.lua

  release:
    name: Package & Release
    runs-on: ubuntu-latest
    needs: tests
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | head -2 | tail -1)
          if [ "$PREV_TAG" = "$GITHUB_REF_NAME" ]; then
            # First release â€” use all commits
            LOG=$(git log --pretty=format:"- %s" HEAD)
          else
            LOG=$(git log --pretty=format:"- %s" "$PREV_TAG".."$GITHUB_REF_NAME")
          fi
          # Write to file for gh release
          {
            echo "## QuickRoute $GITHUB_REF_NAME"
            echo ""
            echo "### Changes"
            echo "$LOG"
            echo ""
            echo "### Installation"
            echo "1. Download \`QuickRoute-${{ steps.version.outputs.version }}.zip\`"
            echo "2. Extract to \`World of Warcraft/_retail_/Interface/AddOns/\`"
            echo "3. Restart WoW or \`/reload\`"
          } > /tmp/release-notes.md

      - name: Package addon
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p dist/QuickRoute
          # Copy addon files (exclude dev/test files)
          cp -r QuickRoute/Core QuickRoute/Data QuickRoute/Modules QuickRoute/Utils dist/QuickRoute/
          cp QuickRoute/QuickRoute.lua QuickRoute/QuickRoute.toc QuickRoute/Localization.lua QuickRoute/embeds.xml dist/QuickRoute/
          # Copy pkgmeta for CurseForge packager compatibility
          cp QuickRoute/.pkgmeta dist/QuickRoute/
          # Create zip
          cd dist
          zip -r "QuickRoute-${VERSION}.zip" QuickRoute/
          echo "Created QuickRoute-${VERSION}.zip ($(du -h "QuickRoute-${VERSION}.zip" | cut -f1))"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          gh release create "$GITHUB_REF_NAME" \
            "dist/QuickRoute-${VERSION}.zip" \
            --title "QuickRoute $GITHUB_REF_NAME" \
            --notes-file /tmp/release-notes.md

      - name: Upload to CurseForge
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Read Interface version from TOC (e.g. 120001)
          TOC_API=$(grep -oP '## Interface:\s*\K\d+' QuickRoute/QuickRoute.toc)
          echo "TOC Interface version: ${TOC_API}"
          # Find matching CurseForge game version ID by apiVersion
          GAME_VERSION_ID=$(curl -s -H "X-Api-Token: ${CF_API_KEY}" \
            "https://wow.curseforge.com/api/game/versions" | \
            python3 -c "
          import json, sys
          versions = json.load(sys.stdin)
          toc_api = '${TOC_API}'
          # Match by apiVersion field (e.g. '120001')
          match = [v for v in versions if v.get('apiVersion') == toc_api]
          if match:
              print(match[0]['id'])
          else:
              # Fallback: highest ID among retail versions (gameVersionTypeID=517)
              retail = [v for v in versions if v.get('gameVersionTypeID') == 517]
              retail.sort(key=lambda v: v['id'], reverse=True)
              print(retail[0]['id'])
          ")
          echo "CurseForge game version ID: ${GAME_VERSION_ID}"
          # Build metadata JSON
          METADATA=$(python3 -c "
          import json
          print(json.dumps({
              'changelog': open('/tmp/release-notes.md').read(),
              'changelogType': 'markdown',
              'displayName': 'QuickRoute v${VERSION}',
              'gameVersions': [int('${GAME_VERSION_ID}')],
              'releaseType': 'release'
          }))
          ")
          # Upload
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "https://wow.curseforge.com/api/projects/1461133/upload-file" \
            -H "X-Api-Token: ${CF_API_KEY}" \
            -F "metadata=${METADATA}" \
            -F "file=@dist/QuickRoute-${VERSION}.zip")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          echo "CurseForge response (HTTP ${HTTP_CODE}): ${BODY}"
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::warning::CurseForge upload failed (HTTP ${HTTP_CODE}). GitHub release was created successfully."
          fi
